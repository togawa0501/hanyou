auth.onAuthStateChanged((user) => {
    if (user) initializeMasterHistoryPage();
    else window.location.href = 'index.html';
});

function initializeMasterHistoryPage() {
    const tourId = localStorage.getItem('fanclub-tour-id');
    if (!tourId) {
        alert("ツアーが選択されていません。");
        window.location.href = 'index.html';
        return;
    }

    const historyTableBody = document.getElementById('history-table-body');
    const csvExportButton = document.getElementById('csv-export-button');
    const resetMasterButton = document.getElementById('reset-master-button');
    
    // ▼▼▼ データ保存場所の変更 ▼▼▼
    const tourRef = db.collection("tours").doc(tourId);
    const masterCollectionRef = tourRef.collection("master_distributions");
    // ▲▲▲
    
    const MASTER_RESET_PASSWORD = "password456"; 
    let allHistoryData = [];

    masterCollectionRef.orderBy('distributedAt', 'desc').onSnapshot(snapshot => {
        historyTableBody.innerHTML = '';
        allHistoryData = [];
        if (snapshot.empty) {
            historyTableBody.innerHTML = `<tr><td colspan="4">まだ配布履歴がありません。</td></tr>`;
            return;
        }
        snapshot.forEach(doc => {
            const data = doc.data();
            allHistoryData.push(data);
            const tr = document.createElement('tr');
            const date = data.distributedAt.toDate().toLocaleString('ja-JP');
            tr.innerHTML = `<td>${date}</td><td>${data.memberId}</td><td>${data.staffName}</td><td>${data.eventName || '不明'}</td>`;
            historyTableBody.appendChild(tr);
        });
    }, error => console.error("Error fetching history:", error));

    resetMasterButton.addEventListener('click', async () => {
        if (prompt("【警告】このツアーの全履歴が削除されます。マスターパスワードを入力：") !== MASTER_RESET_PASSWORD) {
            alert("マスターパスワードが違います。"); return;
        }
        if (confirm("ツアー全体の履歴と、関連するすべてのイベント履歴が削除されます。よろしいですか？")) {
            const masterSnapshot = await masterCollectionRef.get();
            const batch = db.batch();
            masterSnapshot.forEach(doc => {
                const data = doc.data();
                batch.delete(doc.ref);
                if (data.eventId && data.memberId) {
                    batch.delete(tourRef.collection("events").doc(data.eventId).collection("distributions").doc(data.memberId));
                }
            });
            await batch.commit();
            alert("ツアー全体の全履歴と、関連するすべてのイベント履歴をリセットしました。");
        }
    });

    csvExportButton.addEventListener('click', () => { /* ... (省略) ... */ });
}
